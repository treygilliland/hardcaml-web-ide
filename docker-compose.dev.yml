services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
      args:
        BASE_IMAGE: ${BASE_IMAGE:-ghcr.io/treygilliland/hardcaml-base:latest}
    ports:
      - "8000:8000"
    volumes:
      - ./api:/app
      - ./hardcaml:/hardcaml
    environment:
      - PYTHONUNBUFFERED=1
      - UV_PROJECT_ENVIRONMENT=/opt/venv
    command:
      [
        "uv",
        "run",
        "uvicorn",
        "main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8000",
        "--reload",
      ]
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G

  frontend:
    image: node:24-alpine
    working_dir: /app
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - ./hardcaml:/app/hardcaml
      - frontend_node_modules:/app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
      - DOCKER_ENV=true
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    depends_on:
      - backend

volumes:
  frontend_node_modules:
