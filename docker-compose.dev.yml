services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
      args:
        BASE_IMAGE: ${BASE_IMAGE:-ghcr.io/treygilliland/hardcaml-base:latest}
    ports:
      - "8000:8000"
    volumes:
      - ./api:/app
      - ./hardcaml:/hardcaml
    environment:
      - PYTHONUNBUFFERED=1
      - UV_PROJECT_ENVIRONMENT=/opt/venv
    command:
      [
        "uv",
        "run",
        "uvicorn",
        "main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8000",
        "--reload",
      ]
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile.frontend.dev
    ports:
      - "5173:5173"
    volumes:
      # Mount code for live editing
      # node_modules will be created in this mount on first pnpm install
      - ./frontend:/app
      - ./hardcaml:/hardcaml
      - frontend-node_modules:/app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
      - DOCKER_ENV=true
      - CI=true
      - VITE_DOCS_URL=http://localhost:4321
    command: sh -c "cd /app && pnpm install --frozen-lockfile --store-dir=/tmp/pnpm-store && pnpm --filter @hardcaml/ide dev"
    depends_on:
      - backend

  docs:
    build:
      context: .
      dockerfile: frontend/Dockerfile.frontend.dev
    ports:
      - "4321:4321"
    volumes:
      - ./frontend:/app
      - ./hardcaml:/hardcaml
      - docs-node_modules:/app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
      - DOCKER_ENV=true
      - CI=true
      - PUBLIC_IDE_URL=http://localhost:5173
    command: sh -c "cd /app && pnpm install --frozen-lockfile --store-dir=/tmp/pnpm-store && pnpm --filter @hardcaml/docs dev --host 0.0.0.0 --port 4321"

volumes:
  docs-node_modules:
  frontend-node_modules:
