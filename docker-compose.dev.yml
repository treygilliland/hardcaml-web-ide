services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
      args:
        BASE_IMAGE: ${BASE_IMAGE:-ghcr.io/treygilliland/hardcaml-base:latest}
    ports:
      - "8000:8000"
    volumes:
      - ./api:/app
      - ./hardcaml:/hardcaml
    environment:
      - PYTHONUNBUFFERED=1
      - UV_PROJECT_ENVIRONMENT=/opt/venv
    command:
      [
        "uv",
        "run",
        "uvicorn",
        "main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8000",
        "--reload",
      ]
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend.dev
    ports:
      - "5173:5173"
    volumes:
      # Mount code for live editing
      # node_modules will be created in this mount on first pnpm install
      - ./frontend:/app
      - ./hardcaml:/hardcaml
    environment:
      - CHOKIDAR_USEPOLLING=true
      - DOCKER_ENV=true
      - CI=true
    depends_on:
      - backend
