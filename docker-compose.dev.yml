services:
  backend:
    container_name: backend-dev
    build:
      context: .
      dockerfile: Dockerfile.backend
      target: dev
      args:
        BASE_IMAGE: ${BASE_IMAGE:-ghcr.io/treygilliland/hardcaml-base:latest}
    ports:
      - "8000:8000"
    volumes:
      - ./api:/app
      - ./hardcaml:/hardcaml
    environment:
      - PYTHONUNBUFFERED=1
      - UV_PROJECT_ENVIRONMENT=/opt/venv
    command:
      [
        "uv",
        "run",
        "uvicorn",
        "main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8000",
        "--reload",
      ]
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G

  frontend:
    container_name: frontend-dev
    build:
      context: .
      dockerfile: frontend/Dockerfile.frontend.dev
    ports:
      - "4321:4321"
    volumes:
      # Mount code for live editing (node_modules built into image)
      - ./frontend:/app
      - ./hardcaml:/hardcaml
      # Exclude node_modules from bind mount to use built-in ones
      - /app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
      - DOCKER_ENV=true
      - CI=true
      - PUBLIC_API_BASE_URL=http://localhost:8000
    command: pnpm --filter @hardcaml/docs dev --host 0.0.0.0 --port 4321
