{
  "files": {
    "circuit.ml": "open! Core\nopen! Hardcaml\nopen! Signal\n\nlet counter_bits = 8\n\nmodule I = struct\n  type 'a t =\n    { clock : 'a\n    ; clear : 'a\n    ; enable : 'a\n    }\n  [@@deriving hardcaml]\nend\n\nmodule O = struct\n  type 'a t =\n    { count : 'a [@bits counter_bits]\n    }\n  [@@deriving hardcaml]\nend\n\nlet create scope ({ clock; clear; enable } : _ I.t) : _ O.t =\n  let _ = scope in\n  let spec = Reg_spec.create ~clock ~clear () in\n  let open Always in\n  let%hw_var count = Variable.reg spec ~width:counter_bits in\n  compile [ when_ enable [ count <-- count.value +: one counter_bits ] ];\n  { count = count.value }\n;;\n\nlet hierarchical scope =\n  let module Scoped = Hierarchy.In_scope (I) (O) in\n  Scoped.hierarchical ~scope ~name:\"counter\" create\n;;",
    "circuit.mli": "open! Core\nopen! Hardcaml\n\nval counter_bits : int\n\nmodule I : sig\n  type 'a t = { clock : 'a; clear : 'a; enable : 'a }\n  [@@deriving hardcaml]\nend\n\nmodule O : sig\n  type 'a t = { count : 'a }\n  [@@deriving hardcaml]\nend\n\nval hierarchical : Scope.t -> Signal.t I.t -> Signal.t O.t",
    "test.ml": "open! Core\nopen! Hardcaml\nopen! Hardcaml_waveterm\nopen! Hardcaml_test_harness\nmodule Circuit = User_circuit.Circuit\nmodule Harness = Cyclesim_harness.Make (Circuit.I) (Circuit.O)\n\nlet run_testbench (sim : Harness.Sim.t) =\n  let inputs = Cyclesim.inputs sim in\n  let outputs = Cyclesim.outputs sim in\n  let cycle () = Cyclesim.cycle sim in\n  inputs.clear := Bits.vdd;\n  cycle ();\n  inputs.clear := Bits.gnd;\n  inputs.enable := Bits.vdd;\n  for _ = 1 to 10 do cycle () done;\n  let final_count = Bits.to_unsigned_int !(outputs.count) in\n  print_s [%message \"Result\" (final_count : int)];\n  cycle ()\n;;\n\nlet%expect_test \"Counter test\" =\n  Harness.run_advanced\n    ~waves_config:Waves_config.no_waves\n    ~create:Circuit.hierarchical\n    ~trace:`All_named\n    ~print_waves_after_test:(fun waves ->\n      print_endline \"===WAVEFORM_START===\";\n      Waveform.print ~display_width:80 ~wave_width:2 waves;\n      print_endline \"===WAVEFORM_END===\")\n    run_testbench;\n  [%expect {| (Result (final_count 10)) |}]\n;;"
  },
  "timeout_seconds": 30
}
