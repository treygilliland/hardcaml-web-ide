# Hardcaml Web IDE - Development backend image
# Requires: docker build -f Dockerfile.base -t hardcaml-base .

ARG BASE_IMAGE=hardcaml-base
FROM ${BASE_IMAGE}

# Copy and pre-build dune project to warm cache
COPY hardcaml/build-cache/ /opt/build-cache/
RUN cd /opt/build-cache && dune build @runtest --force 2>/dev/null || true

# Install uv
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

# Install Python dependencies to /opt/venv (outside /app so volume mount doesn't shadow it)
COPY api/pyproject.toml api/uv.lock /app/
ENV UV_PROJECT_ENVIRONMENT=/opt/venv
RUN cd /app && uv sync --frozen

WORKDIR /app

EXPOSE 8000

CMD ["uv", "run", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
